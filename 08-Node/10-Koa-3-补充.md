## 一 koa与jwt实现权限控制

常用的资源限制方式：
- 基于cookie：简单方便
- 基于token：无状态，天然支持跨域、前后端分离，但是由于每次访问资源都要校验，给服务器增加了一定压力。无状态API缺乏对用户异常的控制，为了避免出现例如回放攻击的异常情况，应该设置较短的过期时间，且需要对密钥进行严格保护。对于高危场景，如支付，应谨慎选择Token方式。  

## 二 koa与消息队列

一般来说，消息队列有两种场景：
- 发布订阅模式：发布者向某个频道发布一条消息后，多个订阅者都会收到同一个消息
- 生产消费模式：生产者生产消息放到队列里，消费者同时监听队列，如果队列里有了新的消息就将其取走，对于单条消息，只能由一个消费者消费

发布订阅模式：
```js
// publisher
var redis = require("redis");
var client = redis.createClient(6379, "127.0.0.1");
client.on("error", function(err){
    console.log(err);
});
client.on("ready", function(){
    client.publish("channel1", "hello");
});

//subsciber
var redis = require("redis");
var client = redis.createClient(6379, "127.0.0.1");
client.on("error", function(err){
    console.log(err);
});
client.subscribe("channel1");
client.on("message", function(channel, message){
    console.log("channel: ", channel);
    console.log("message: ", message);
});
```


## 三 Koa源码阅读

koa的中间件：  

中间件的本质是一个函数，在koa中，该函数通常具有ctx和next两个参数，分别表示封装好的req/res对象以及下一个要执行的中间件，当有多个中间件的时候，本质上是一种嵌套调用，就像洋葱。  

koa和express都是用app.use()来加载中间件，但是内部实现大不相同，koa的源码文件Application.js中定义了use方法：
```js
use(fn){
    //....
    this.middleware.push(fn);
    return this;
}
```
koa在application.js中维护了一个middleware的数组，如果有新的中间件被加载，就push到这个数组中。
